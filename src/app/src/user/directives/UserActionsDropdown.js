'use strict';

function UserActionsDropdown($dropdown) {
    return {
        scope: {userActionsDropdown: '=', record: '='},
        controller: 'UserDeleteCtrl',
        controllerAs: 'vm',
        restrict: 'A',
        link: function(scope, element, attrs, UserDeleteCtrl) {
            var dropdown = $dropdown(element, {
                templateUrl: 'gzero/admin/views/user/directives/userActionsDropdown.tpl.html',
                animation: 'am-flip-x',
                placement: 'bottom-right'
            });

            element.on('click', function() {
                // TODO better params replacement and functions handling
                _.mapValues(scope.userActionsDropdown, function(n) {
                    if (typeof n.url !== 'undefined') {
                        // Record id
                        if (n.url.indexOf('record_id') !== -1) {
                            n.url = n.url.replace('record_id', scope.record.id);
                        }
                    } else if (typeof n.href !== 'undefined') {
                        // Record id
                        if (n.href.indexOf('record_id') !== -1) {
                            n.href = n.href.replace('record_id', scope.record.id);
                        }
                    }
                    return n;
                });

                dropdown.$scope.user = scope.userActionsDropdown;
                dropdown.$scope.record = scope.record; // Pass user id to the view
                dropdown.$scope.deleteModal = UserDeleteCtrl.deleteModal; // Pass delete action to the view
            });
        }
    };
}

UserActionsDropdown.$inject = [];
module.exports = UserActionsDropdown;
