'use strict';

function ContentAddCtrl($scope, $state, $stateParams, listParent, ContentRepository) {
    var parentId = null;
    // if parent category exists
    if (typeof listParent !== 'undefined') {
        $scope.listParent = listParent; // selected category
        parentId = listParent.id;
    }
    // default translations lang code
    $scope.newContent = {
        type: $stateParams.type,
        isActive: true,
        translations: {
            langCode: $scope.listLang.code
        }
    };
    // contents POST action
    $scope.addNewContent = function addNewContent(newContent) {
        newContent.parentId = parentId; // set parent category as null
        // if parent category exists
        if (typeof $scope.listParent !== 'undefined') {
            // check for route translation in selected language
            var route = _.pluck(_.filter($scope.listParent.route.translations, 'lang', newContent.translations.langCode), 'url');
            if (!route.length) {
                newContent.parentId = null; // if not found set as uncategorized
            }
        }
        ContentRepository.newContent(newContent).then(function(response) {
            if ($stateParams.type === 'category') {
                // when create a category then set it as a new listParent on content list
                $state.go('content.list', {contentId: response.id}, {reload: true});
            } else {
                // otherwise go to list without new listParent
                $state.go('content.list', {}, {reload: true});
            }
        });
    };
}
ContentAddCtrl.$inject = ['$scope', '$state', '$stateParams', 'listParent', 'ContentRepository'];
module.exports = ContentAddCtrl;
