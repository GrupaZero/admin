'use strict';

function ContentAddCtrl($scope, $state, $stateParams, listParent, ContentRepository) {
    var parentId = null;
    $scope.contentType = $stateParams.type;
    // if parent category exists
    if (typeof listParent !== 'undefined') {
        $scope.listParent = listParent; // selected category
        parentId = listParent.id;
    }
    // default translations lang code
    $scope.newContent = {
        type: $stateParams.type,
        isActive: true,
        translations: {
            langCode: $scope.listLang.code
        }
    };

    // Angular strap dropdown for save button
    $scope.contentSaveButtonLinks = [
        {
            text: 'SAVE_AND_CONTINUE_EDITING',
            click: 'addNewContent(newContent, "content.edit.details")'
        },
        {
            divider: true
        },
        {
            text: 'SAVE_AND_ADD_ANOTHER',
            click: 'addNewContent(newContent, "content.add")'
        }
    ];

    // contents POST action
    $scope.addNewContent = function addNewContent(newContent, redirect) {
        newContent.parentId = parentId; // set parent category as null
        newContent.publishedAt = new Date().toISOString().slice(0, 19).replace('T', ' '); // set publish at date
        // if parent category exists
        if (typeof $scope.listParent !== 'undefined') {
            // check for route translation in selected language
            var route = _.pluck(_.filter($scope.listParent.route.translations, 'lang', newContent.translations.langCode), 'url');
            if (!route.length) {
                newContent.parentId = null; // if not found set as uncategorized
            }
        }
        ContentRepository.newContent(newContent).then(function(response) {
            // when there is custom redirect
            if (typeof redirect !== 'undefined') {
                var params = (redirect === 'content.edit.details') ? {
                    contentId: response.id,
                    langCode: newContent.translations.langCode
                } : {type: $stateParams.type};

                $state.go(redirect, params, {reload: true});
            } else {
                if ($stateParams.type === 'category') {
                    // when create a category then set it as a new listParent on content list
                    $state.go('content.list', {contentId: response.id}, {reload: true});
                } else {
                    // otherwise go to list without new listParent
                    $state.go('content.list', {}, {reload: true});
                }
            }
        });
    };
}
ContentAddCtrl.$inject = ['$scope', '$state', '$stateParams', 'listParent', 'ContentRepository'];
module.exports = ContentAddCtrl;
